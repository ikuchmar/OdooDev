1) Краткое описание задач, которые обсуждались

Пакетная озвучка текстовых файлов для изучения языков (EN/RU/UK) с мужскими голосами, интонацией и неторопливым темпом.

Автодетект языка + приоритет явных маркеров в тексте, выбор конкретного голоса, fallback на альтернативные.

Гибкое управление паузами (между фразами, за переносы строк, за группы пробелов).

Рекурсивная обработка папок, сохранение аудио рядом с исходными файлами с тем же именем (расширение .mp3).

Генерация синхронизационного файла *.slides.txt с длительностью по строкам.

Миграция конфигурации из JSON → TOML, упрощение структуры и добавление «справочных» блоков.

2) Внесённые изменения в ТЗ

Источник конфигурации: TOML вместо JSON (tts_config.toml).

Параметр входов: input_dirs вместо inputs; параметр рекурсии: recurse вместо recursive_inputs.

Логика slides: считать только по непустым строкам исходника (каждая непустая строка → одна строка в *.slides.txt; пустые игнорируются).

Паузы:

Паузы больше не отправляются отдельными кусками в TTS; всегда «пришиваются» к следующему фрагменту.

Унифицировали управление паузами через between_phrases_ms, newline_pause.ms_per_newline, space_pause.ms_per_space, start_of_line_extra_pause_ms.

Fallback:

Такой же механизм fallback на альтернативные голоса теперь для RU и UK, как и для EN.

Опция строгого режима (не переключаться на альтернативы) поддерживается на уровне каждого языка.

Маркеры и голоса:

Приоритет явных языковых маркеров над авто-детектом.

Встроены голосовые маркеры (v:алиас) / (voice:алиас) и «сахар» [EN:aliаs].

Поддержка поиска по подстроке, если алиас не найден явно.

Файловые фильтры по суффиксу: для каждого языка можно включить suffix_filter (*_en, *_ru, *_uk) — такой файл озвучивается только указанным языком.

Возможность multi-EN: создавать по одному MP3+slides для каждого голоса из alt_voices для EN.

3) Новые или изменённые скрипты/файлы

tts_batch_reader.py (v16.3) — актуальная версия скрипта:

Читает tts_config.toml (через tomllib).

Рекурсивно ищет входные файлы (по input_dirs + recurse + extensions).

Размечает текст по маркерам/делимитерам и группирует по языкам.

Склеивает паузы к следующему фрагменту (нет «голых пауз»).

Синтезирует речь (edge-tts), считает длительность кусочков (mutagen), собирает slides по строкам исходника.

Поддерживает multi_en_outputs.

tts_config.toml — новая конфигурация:

Разделы: входы, языки (voices/alt_voices/strict/markers/suffix_filter/detect_prefixes/voice_aliases), паузы, общие флаги.

Добавлены справочные блоки (каталоги голосов, примеры путей), которые скрипт игнорирует.

Побочные файлы:

Выход: *.mp3 рядом с исходником.

Синхронизация: *.slides.txt рядом с соответствующим *.mp3 (или с суффиксом __VOICE.slides.txt для multi-EN).

4) Используемые параметры и настройки

Вход и обход:

input_dirs: [ ... ] — папки/маски (абсолютные/относительные).

recurse: true|false — рекурсивный обход подпапок.

extensions: [".txt"] — расширения источников.

enable_languages: ["en","ru","uk"] — языки по умолчанию (если не сработал суффикс-фильтр).

Языки ([languages.<code>]):

voice — основной голос (напр. "en-GB-SoniaNeural").

alt_voices — fallback-голоса (список).

strict_no_fallback: true|false — запрещать ли переключение при ошибке.

markers — явные маркеры языка в тексте (напр. "[EN]", "_ru_", "(uk)", "ru:").

detect_prefixes — соответствия кодам langdetect (напр. ["en"]).

suffix_filter.enabled: true|false, suffix_filter.suffix: "_en" — жёсткий суффикс файла → файл озвучивается только этим языком.

voice_aliases — карта алиасов → ID голоса (напр. guy="en-US-GuyNeural").

Голоса и маркеры:

В тексте: (v:aliаs) / (voice:aliаs) и [EN:aliаs] / [EN].

voice_marker_prefixes = ["v:", "voice:"].

allow_partial_voice_match: true|false — поиск по подстроке по списку [voice] + alt_voices.

Паузы:

pauses.between_phrases_ms — базовая пауза между фразами.

pauses.newline_pause.enabled, pauses.newline_pause.ms_per_newline — пауза за каждый перенос строки.

pauses.space_pause.enabled, pauses.space_pause.ms_per_space — пауза за группы пробелов (универсальный вариант вместо «двойной/тройной»).

pauses.start_of_line_extra_pause_ms — доп. пауза в начале строки (после переноса).

sentence_delimiters — список разделителей конца фразы (включая "\n").

rate — темп (в %, отрицательное — медленнее).

strip_symbols — символы для удаления из речи.

strip_emojis: true|false — удалять эмодзи/«экзотику».

Выходы:

multi_en_outputs: true|false — отдельный MP3/Slides для каждого EN-голоса из alt_voices.

*.slides.txt — одна строка на одну непустую строку исходника (сумма длительностей всех фрагментов, озвученных в этой строке).

5) Правила и договорённости, которые появились

Пустые строки исходника в slides игнорируются всегда.
Итоговый slides.txt содержит строки только для тех строк исходника, где реально что-то озвучено.

Явные маркеры языка ([EN], _ru_, (uk), ru: и т.д.) имеют приоритет над авто-детектом.

Голосовые маркеры в тексте ((v:aliаs), (voice:aliаs), [EN:aliаs]) переключают голос на лету:

если алиас есть в voice_aliases — берём его,

если нет — при включённом allow_partial_voice_match ищем по подстроке среди [voice] + alt_voices,

иначе остаётся основной voice.

Fallback по ошибке синтеза у EN/RU/UK одинаковый: если strict_no_fallback=false, пробуем alt_voices по очереди.

Паузы «внутри» текста не отправляются как отдельные куски (устранена ошибка «No audio was received» на «голых паузах»).

Суффиксы имён файлов (*_en, *_ru, *_uk) при включённом suffix_filter делают файл моноязычным для рендера.

Новые языки добавляются без перепрограммирования — достаточно определить секцию в tts_config.toml.

6) Нерешённые вопросы / идеи на будущее

Автоматический мигрирующий скрипт JSON→TOML (и обратно) для быстрой синхронизации старых конфигов.

Отдельный «режим словаря»: склеивать «слово + перевод» в один единый блок для TTS (с отдельными паузами) и писать единый тайминг — сейчас это достигается новой логикой slides по строкам, но можно выделить отдельный пресет.

Возможность опционально фиксировать пустые строки в slides.txt нулём (0.000) — сейчас пустые гарантированно игнорируются по договорённости.