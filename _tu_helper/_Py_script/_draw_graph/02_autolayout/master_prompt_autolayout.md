# Master Prompt ТЗ — Подпрограмма 02_autolayout

## Назначение
Подпрограмма `02_autolayout` выполняет автоматическую раскладку блоков графа и маршрутизацию стрелок (рёбер) между ними.  
Цель: повысить наглядность диаграммы, избежать пересечений стрелок с блоками и автоматически упорядочивать блоки в удобном порядке.

---

## Основные задачи
1. **Чтение входных файлов** `.toml` с описанием графа (например, `flow.graph_01.toml`).  
   - Исходный файл остаётся неизменным. 
   - скрипт ищет файл согласно параметра input_suffix
   - Скрипт формирует новый файл `<имя>_02.toml` с координатами блоков и информацией о маршрутах стрелок.

2. **Автоматическая раскладка блоков**:
   - Поддержка направлений: `LR` (слева направо), `RL` (справа налево), `TB` (сверху вниз), `BT` (снизу вверх).  
   - Блоки упорядочиваются автоматически:  
     - Режимы `order.mode = auto | topological | input`.  
     - По умолчанию используется топологическая сортировка; при циклах — многослойный порядок (BFS).  
     - Для направлений `RL` и `BT` порядок инвертируется.

3. **Маршрутизация стрелок** (рёбер):
   - Попытка прямого соединения.  
   - Если пересекает блок — строится ортогональный dogleg (1 изгиб).  
   - Если и это невозможно — гарантированный обход: стрелка прокладывается ортогонально через коридор **выше или ниже** всех блоков.  
   - Настройки:
     - `avoid_nodes` — включить/выключить обход блоков (true/false).  
     - `avoid_padding` — отступ для обхода (рекомендуется 0.08–0.20).  
     - `avoid_direction` — `auto`, `above` или `below`.  
   - Порты соединения (`connector_from` / `connector_to`) выбираются автоматически в зависимости от взаимного расположения блоков.

4. **Вывод в результирующий `.toml`**:
   - Для блоков: `auto_pos`.  
   - Для стрелок:  
     - `auto_curve` (straight/orthogonal),  
     - `auto_connector_from` / `auto_connector_to`,  
     - `auto_waypoints` (список промежуточных точек),  
     - `auto_label_offset`.

5. **Файл конфигурации `config_autolayout.toml`**:  
   Содержит секции:
   - `[io]` — входные/выходные файлы, фильтры, режим остановки при ошибке.  
   - `[layout]` — направление (`direction`).  
   - `[order]` — режим сортировки (`mode`).  
   - `[edges]` — параметры маршрутизации стрелок.  
   - `[defaults]` — размеры блоков и смещение подписей.  

---

## Важные договорённости
- Входные файлы `*_01.toml` остаются неизменными.  
- Скрипт всегда создаёт `*_02.toml` рядом с исходным файлом.  
- Код максимально простой, без внешних зависимостей (только стандартная библиотека Python).  
- Весь код снабжён русскими комментариями.  
- Конфиг содержит максимально подробные комментарии по каждому параметру.  
- Имя скрипта всегда строго `autolayout.py`.  
- Имя конфига всегда строго `config_autolayout.toml`.
- Для удобства отладки добавлен параметр `stop_on_error`.  

---

## Пример настроек

```toml
[io]
input_dirs = ["D:/Entertaiment/Графы/Пример 1"]
recursive = true
include_extensions = ["toml"]
exclude_patterns = ["*_02.toml", "*_03.toml"]
input_suffix = "_01.toml"
output_suffix = "_02"
stop_on_error = true

[layout]
direction = "LR"   # варианты: LR|RL|TB|BT

[order]
mode = "auto"      # auto|topological|input

[edges]
curve = "auto"           # auto|straight|orthogonal
avoid_nodes = true
avoid_padding = 0.12     # 0.08–0.20
avoid_direction = "auto" # auto|above|below
connector_from = "right"
connector_to   = "left"

[defaults]
block.width = 0.12
block.header_height = 0.10
block.prop_height   = 0.06
style.label_offset = 0.5
```

---

## Результат
1. На выходе всегда появляется файл `<имя>_02.toml` с координатами блоков (`auto_pos`) и маршрутами стрелок (`auto_curve`, `auto_waypoints`, и т.д.).  
2. Стрелки гарантированно обходят блоки (либо через dogleg, либо через верх/низ).  
3. Порядок блоков соответствует заданному направлению и обеспечивает наглядность.  

---

## Нерешённые вопросы
- Возможность выбора между «ортогональными» и «сглаженными кривыми» обхода.  
- Поддержка нескольких слоёв блоков (не только линейное выравнивание).  
