# 01_prepare — ТЗ (нормализация и миграция графов)

## Назначение
Подпрограмма приводит входные TOML-графы к единому «эталонному» формату:
- мигрирует устаревшие конструкции (`[[arrows]]`, краткая запись `outs=[...]`) в вложенные связи `[[blocks.outs]]`;
- удаляет старые `auto_*`-поля;
- дедуплицирует повторяющиеся рёбра;
- нормализует порядок ключей, пробелы/переводы строк, базовые типы;
- выполняет базовую валидацию структуры.

Выходом является **новый файл данных графа** в той же папке, что и исходник, с суффиксом:
```
<name>.s01.prepared.toml
```

## Размещение
```
01_prepare/
  ├─ prepare.py          # скрипт (будет создан позже)
  └─ config.toml         # конфигурация подпрограммы
```
- Конфигурация читается **из файла `config.toml` в этой же папке**.
- Все промежуточные **файлы данных графа** пишутся в **ту же папку, где лежит исходный .toml**.

## Вход/выход
- **Вход**: все файлы с расширениями/шаблонами, указанными в конфигурации (`[io]`).
- **Выход**: в той же директории, рядом с исходным файлом, имя по шаблону:
  - `name.s01.prepared.toml`
- **Правила записи**: по умолчанию «новый файл», исходник не трогаем. Опционально можно включить «inplace» (перезапись) и/или «backup».

## Алгоритм обработки
1. **Загрузка и парсинг** TOML.
2. **Миграция связей**:
   - `[[arrows]]` → `[[blocks.outs]]` (на уровне соответствующих блоков);
   - краткая запись `outs=["A","B"]` у блока → `[[blocks.outs]]` с правильными целями.
3. **Очистка `auto_*`**:
   - удаляются все `auto_*`-поля у блоков, стрелок, глобальных секций.
4. **Дедупликация рёбер**: для каждого блока удаляются дубликаты `outs` (с учётом типа/направления).
5. **Нормализация**:
   - единый порядок ключей в блоках (сначала `title`, затем основные визуальные поля, потом `outs`);
   - обрезка лишних пробелов, унификация перевода строк (LF), UTF‑8 без BOM.
6. **Валидация (базовая)**:
   - заголовки блоков не пустые;
   - все ссылки в `outs` указывают на существующие блоки (иначе `WARN` и пропуск ребра);
   - отсутствуют циклические дубликаты на одном уровне;
   - опционально: проверка допустимых границ числовых полей (если они есть).
7. **Запись** в файл `*.s01.prepared.toml` рядом с исходником.

## Конфигурация `config.toml`
```toml
[io]
recursive = true
include_extensions = ["toml"]
include_globs = ["**/*.toml"]   # опционально
exclude_patterns = []           # glob-шаблоны исключений
write_mode = "new"              # "new" | "inplace"
backup_original = false         # если write_mode="inplace", делать ли .bak
dry_run = false                 # только отчёт, без записи
stop_on_error = true            # прервать этап при первой критичной ошибке

[migration]
convert_arrows = true
remove_global_arrows = true
wipe_auto_fields = true
dedupe_outs = true

[normalize]
sort_keys = true
newline = "LF"                 # LF | CRLF
encoding = "utf-8"             # фиксировано
```

## Отчёт и диагностика
- По каждому файлу: список применённых преобразований, предупреждения, ошибки.
- Сводка по этапу: N файлов, мигрировано X стрелок, удалено Y `auto_*`, предупреждений Z.

## Гарантии и ограничения
- Содержимое, не относящееся к поддерживаемым ключам, сохраняется (если не конфликтует с TOML).
- Этап **не добавляет** новых визуальных параметров; только нормализация и миграция.
