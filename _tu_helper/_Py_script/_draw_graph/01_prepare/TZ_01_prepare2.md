# ТЗ / Master‑Prompt для подпрограммы 01_prepare

## Назначение
Нормализовать входные TOML‑файлы графов, не выполняя вычислений. Подготовить данные к авторазмещению и рендерингу.

## Вход / Выход
- **Вход**: файлы `*.toml` с описанием графа (сырые данные).
- **Выход**: нормализованные файлы `*_01.toml` в той же папке, что и исходник.

## Конфигурация (config_prepare.toml)
Разделы/ключи (значения по умолчанию — пример):
```toml
[io]
input_dirs = ["D:/Entertaiment/Графы/Пример 1"]
recursive = true
include_extensions = ["toml"]
exclude_patterns = ["*_01.toml", "*_02.toml", "*_03.toml"] # чтобы не переобрабатывать
input_suffix = ".toml"   # что считаем «сырым»
output_suffix = "_01"    # добавляется перед .toml
write_mode = "new"       # "new" | "inplace"
backup_original = false
dry_run = false
stop_on_error = true

[ensure]
add_missing_properties = true         # для каждого [[blocks]] гарантировать properties = []
add_missing_outs       = true         # для каждого [[blocks]] гарантировать outs = []
force_label_on_outs    = false        # label на рёбрах добавляем на этапе 02 (см. ниже)
generate_block_ids     = "off"        # "off" | "slug" | "uuid"
slug_maxlen            = 40
add_default_meta       = false
title_from_filename    = true         # если нет явного заголовка — брать из имени файла
default_canvas_size    = [1200, 800]

[migration]
dedupe_outs = true                     # убрать дублирующиеся записи в [[blocks.outs]]
```

## Обязательные преобразования
1. Для каждого `[[blocks]]`:
   - если нет `properties` — создать `properties = []`;
   - если нет `outs` — создать `outs = []`;
   - **перед каждым `[[blocks]]` вставить одну ПУСТУЮ строку** (не более одной) для удобства чтения.
2. Не вычислять никаких `auto_*` значений (позиции, размеры, стили не трогаем).
3. Не создавать/не менять поля, связанные с рендером.

## Нефункциональные требования
- **Идемпотентность**: повторный запуск над уже нормализованным файлом ничего не меняет.
- **Комментариев/форматирования не касаться**, кроме добавления одной пустой строки перед `[[blocks]]`.
- **Логи**: краткий отчёт — сколько файлов найдено/обработано/пропущено.

## Пограничные случаи
- Файлы без `[[blocks]]` — пропустить с предупреждением.
- Объекты с `outs` не‑списком — привести к списку или сообщить об ошибке в зависимости от настроек.
- Символы BOM/кириллица в путях — поддерживаются (UTF‑8).

## Критерии приёмки
- Сырые файлы не изменяются (если `write_mode="new"`).
- В результате у каждого блока есть `properties = []` и `outs = []`.
- Пустая строка перед каждым `[[blocks]]` присутствует.
- Повторный запуск не приводит к диффам.

> **Важно для новых чатов:** не писать код, пока пользователь явно не попросит. Работать строго по этому ТЗ.
